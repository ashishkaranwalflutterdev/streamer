<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listen to Audio</title>
</head>
<body>
  <h1>Listen to Audio</h1>
  <audio id="audio" controls autoplay></audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const audio = document.getElementById('audio');
    const mediaSource = new MediaSource();
    audio.src = URL.createObjectURL(mediaSource);

    let sourceBuffer;

    mediaSource.addEventListener('sourceopen', () => {
      console.log('MediaSource opened');
      sourceBuffer = mediaSource.addSourceBuffer('audio/webm; codecs=opus');
      console.log('SourceBuffer created');
    });

    mediaSource.addEventListener('sourceended', () => {
      console.log('MediaSource ended');
    });

    socket.on('connect', () => {
      console.log('Connected to the server');
    });

    socket.on('audio-stream', (data) => {
      console.log('Audio stream received', data);
      if (data instanceof ArrayBuffer) {
        if (sourceBuffer && !sourceBuffer.updating && mediaSource.readyState === 'open') {
          sourceBuffer.appendBuffer(new Uint8Array(data));
          console.log('Audio data appended to SourceBuffer');
        } else {
          console.log('SourceBuffer not ready for appending');
        }
      } else {
        console.error('Received data is not an ArrayBuffer:', data);
      }
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from the server');
    });

    mediaSource.addEventListener('sourceclose', () => {
      console.log('MediaSource closed');
    });

    mediaSource.addEventListener('error', (e) => {
      console.error('MediaSource error:', e);
    });

    if (sourceBuffer) {
      sourceBuffer.addEventListener('updateend', () => {
        console.log('SourceBuffer update ended, ready for more data.');
      });

      sourceBuffer.addEventListener('error', (e) => {
        console.error('SourceBuffer error:', e);
      });
    }
  </script>
</body>
</html>
